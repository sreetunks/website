<!DOCTYPE html>
<html lang="{{ site.Language.LanguageCode }}" dir="{{ or site.Language.LanguageDirection `ltr` }}">
<head>
  <script>
    (function() {
      var theme = localStorage.getItem('theme');
      if (theme) {
        document.documentElement.setAttribute('data-theme', theme);
      }
    })();
  </script>
  {{ partial "head.html" . }}
</head>
<body>
  <header>
    {{ partial "header.html" . }}
  </header>
  <main>
    {{ block "main" . }}{{ end }}
  </main>
  <footer>
    {{ partial "footer.html" . }}
  </footer>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Theme toggle
      var themeToggle = document.querySelector('.theme-toggle');
      if (themeToggle) {
        function getEffectiveTheme() {
          var stored = localStorage.getItem('theme');
          if (stored) return stored;
          return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
        }

        themeToggle.addEventListener('click', function() {
          var current = getEffectiveTheme();
          var next = current === 'dark' ? 'light' : 'dark';
          document.documentElement.setAttribute('data-theme', next);
          localStorage.setItem('theme', next);
        });
      }

      // Language dropdown toggle
      var dropdown = document.querySelector('.lang-dropdown');
      if (dropdown) {
        var langToggle = dropdown.querySelector('.lang-toggle');

        langToggle.addEventListener('click', function(e) {
          e.stopPropagation();
          dropdown.classList.toggle('open');
          langToggle.setAttribute('aria-expanded', dropdown.classList.contains('open'));
        });

        document.addEventListener('click', function(e) {
          if (!dropdown.contains(e.target)) {
            dropdown.classList.remove('open');
            langToggle.setAttribute('aria-expanded', 'false');
          }
        });
      }
    });
  </script>

  {{- /* Optional: Mermaid support (kept minimal). */ -}}
  {{- if .Store.Get "hasMermaid" -}}
  <script type="module">
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.esm.min.mjs';
    function getTheme() {
      var stored = localStorage.getItem('theme');
      if (stored) return stored === 'dark' ? 'dark' : 'default';
      return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'default';
    }
    mermaid.initialize({ startOnLoad: false, securityLevel: 'loose', theme: getTheme() });
    mermaid.run({ querySelector: '.mermaid' });
  </script>
  {{- end -}}
</body>
</html>
